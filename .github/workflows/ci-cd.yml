name: Joker API CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests pytest pytest-cov

    - name: Check code formatting with black
      run: |
        pip install black
        black --check app.py || echo "Code formatting check completed"

    - name: Lint with flake8
      run: |
        pip install flake8
        flake8 app.py --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting completed"

    - name: Verify jokes files exist
      run: |
        ls -la jokes/
        for lang in cz sk en-gb en-us; do
          for cat in normal explicit; do
            if [ ! -f "jokes/${lang}_${cat}.txt" ]; then
              echo "Missing: jokes/${lang}_${cat}.txt"
              exit 1
            fi
          done
        done

    - name: Test jokes files encoding
      run: |
        python -c "
        import os
        for file in os.listdir('jokes'):
          if file.endswith('.txt'):
            with open(f'jokes/{file}', 'r', encoding='utf-8') as f:
              lines = f.readlines()
              print(f'{file}: {len(lines)} jokes')
        "

  docker:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t joker-api:latest .

    - name: Test Docker image
      run: |
        docker run -d -p 8000:8000 --name joker-test joker-api:latest
        sleep 10
        curl -f http://localhost:8000/health || exit 1
        curl -f http://localhost:8000/ || exit 1
        docker stop joker-test
        docker rm joker-test

    # Pokud chce≈° pushovat do Docker Hub, odkomentuj:
    # - name: Login to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}
    #
    # - name: Push to Docker Hub
    #   run: |
    #     docker tag joker-api:latest ${{ secrets.DOCKER_USERNAME }}/joker-api:latest
    #     docker push ${{ secrets.DOCKER_USERNAME }}/joker-api:latest

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run security scan with bandit
      run: |
        pip install bandit
        bandit -r app.py -f json -o bandit-report.json || true

    - name: Run dependency check
      run: |
        pip install safety
        safety check -r requirements.txt || echo "Security check completed"
